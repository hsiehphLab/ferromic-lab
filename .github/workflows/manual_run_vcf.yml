name: Manual Run VCF Pipeline

on:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable

      - name: Prepare directories
        run: |
          set -euo pipefail
          echo "[Prepare directories] Current working directory: $(pwd)"
          echo "[Prepare directories] Listing parent directory before creation:"
          ls -al ..
          mkdir -p ../vcfs
          echo "[Prepare directories] Ensured ../vcfs exists"

      - name: Download VCF and index files
        run: |
          set -euo pipefail

          download_with_diagnostics() {
            local url="$1"
            local context="$2"
            local max_attempts=3
            local attempt=1
            local sleep_seconds=10
            local filename

            filename="$(basename "${url%%\?*}")"

            while (( attempt <= max_attempts )); do
              echo "$context Attempt $attempt/$max_attempts for $filename"
              echo "$context Performing HEAD request to inspect availability"

              local head_output head_status
              if ! head_output="$(curl --silent --show-error --location --head "$url" 2>&1)"; then
                echo "$context HEAD request failed for $url"
                head_status="curl_failed"
              else
                head_status="$(echo "$head_output" | awk 'toupper($1) ~ /^HTTP/ {code=$2} END{print code}')"
              fi

              if [[ -n "$head_output" ]]; then
                echo "$context HEAD response for $filename:"
                echo "$head_output"
              fi

              if [[ "$head_status" != "200" && "$head_status" != "206" ]]; then
                echo "$context Warning: HEAD request returned status '$head_status' for $filename"
              fi

              echo "$context Starting download for $filename"
              if curl --fail --show-error --location --remote-name "$url"; then
                echo "$context Successfully downloaded $filename"
                return 0
              fi

              local exit_code=$?
              echo "$context ERROR: curl exited with code $exit_code for $filename"
              (( attempt++ ))

              if (( attempt <= max_attempts )); then
                echo "$context Retrying download for $filename after $sleep_seconds seconds"
                sleep "$sleep_seconds"
              fi
            done

            echo "$context FATAL: Failed to download $filename after $max_attempts attempts"
            return 1
          }

          temp_dir="$(mktemp -d)"
          echo "[Download VCF] Created temporary directory: $temp_dir"
          pushd "$temp_dir"
          urls=(
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr1.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr2.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr3.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr4.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr5.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr6.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr7.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr8.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr9.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr10.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr11.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr12.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr13.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr14.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr15.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr16.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr17.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr18.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr19.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr20.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr21.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr22.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chrX.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr1.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr2.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr3.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr4.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr5.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr6.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr7.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr8.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr9.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr10.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr11.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr12.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr13.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr14.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr15.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr16.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr17.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr18.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr19.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr20.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr21.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chr22.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
            "https://sharedspace.s3.msi.umn.edu/public_internet/chrX.fixedPH.simpleINV.mod.all.wAA.myHardMask98pc.vcf.gz.tbi"
          )
          echo "[Download VCF] Total URLs to fetch: ${#urls[@]}"
          for url in "${urls[@]}"; do
            download_with_diagnostics "$url" "[Download VCF]"
          done
          echo "[Download VCF] Files downloaded to $temp_dir:"
          ls -alh
          popd
          echo "[Download VCF] Moving files from $temp_dir to ../vcfs"
          mv "$temp_dir"/* ../vcfs/
          echo "[Download VCF] Contents of ../vcfs after move:"
          ls -alh ../vcfs
          rmdir "$temp_dir"
          echo "[Download VCF] Removed temporary directory"

      - name: Download configuration and reference files
        run: |
          set -euo pipefail

          download_with_diagnostics() {
            local url="$1"
            local context="$2"
            local max_attempts=3
            local attempt=1
            local sleep_seconds=10
            local filename

            filename="$(basename "${url%%\?*}")"

            while (( attempt <= max_attempts )); do
              echo "$context Attempt $attempt/$max_attempts for $filename"
              echo "$context Performing HEAD request to inspect availability"

              local head_output head_status
              if ! head_output="$(curl --silent --show-error --location --head "$url" 2>&1)"; then
                echo "$context HEAD request failed for $url"
                head_status="curl_failed"
              else
                head_status="$(echo "$head_output" | awk 'toupper($1) ~ /^HTTP/ {code=$2} END{print code}')"
              fi

              if [[ -n "$head_output" ]]; then
                echo "$context HEAD response for $filename:"
                echo "$head_output"
              fi

              if [[ "$head_status" != "200" && "$head_status" != "206" ]]; then
                echo "$context Warning: HEAD request returned status '$head_status' for $filename"
              fi

              echo "$context Starting download for $filename"
              if curl --fail --show-error --location --remote-name "$url"; then
                echo "$context Successfully downloaded $filename"
                return 0
              fi

              local exit_code=$?
              echo "$context ERROR: curl exited with code $exit_code for $filename"
              (( attempt++ ))

              if (( attempt <= max_attempts )); then
                echo "$context Retrying download for $filename after $sleep_seconds seconds"
                sleep "$sleep_seconds"
              fi
            done

            echo "$context FATAL: Failed to download $filename after $max_attempts attempts"
            return 1
          }

          temp_dir="$(mktemp -d)"
          echo "[Download config] Created temporary directory: $temp_dir"
          pushd "$temp_dir"
          echo "[Download config] Starting downloads"
          config_urls=(
            "https://sharedspace.s3.msi.umn.edu/public_internet/hg19.fa"
            "https://sharedspace.s3.msi.umn.edu/public_internet/hg38.no_alt.fa"
            "https://sharedspace.s3.msi.umn.edu/public_internet/hg38.no_alt.fa.fai"
            "https://sharedspace.s3.msi.umn.edu/public_internet/variants_freeze4inv_sv_inv_hg38_processed_arbigent_filtered_manualDotplot_filtered_PAVgenAdded_withInvCategs_syncWithWH.fixedPH.simpleINV.mod.tsv"
            "https://sharedspace.s3.msi.umn.edu/public_internet/gencode.v47.basic.annotation.gtf"
            "https://sharedspace.s3.msi.umn.edu/public_internet/hardmask.hg38.v4_acroANDsdOnly.over99.bed"
          )
          for url in "${config_urls[@]}"; do
            download_with_diagnostics "$url" "[Download config]"
          done
          echo "[Download config] Downloaded files:"
          ls -alh
          popd
          echo "[Download config] Moving configuration files to repository root"
          mv "$temp_dir"/hg19.fa ../
          mv "$temp_dir"/hg38.no_alt.fa ../
          mv "$temp_dir"/hg38.no_alt.fa.fai ../
          mv "$temp_dir"/variants_freeze4inv_sv_inv_hg38_processed_arbigent_filtered_manualDotplot_filtered_PAVgenAdded_withInvCategs_syncWithWH.fixedPH.simpleINV.mod.tsv ../
          mv "$temp_dir"/gencode.v47.basic.annotation.gtf ../
          mv "$temp_dir"/hardmask.hg38.v4_acroANDsdOnly.over99.bed ../
          echo "[Download config] Listing repository root after moving files:"
          ls -alh .. | head -n 50
          rmdir "$temp_dir"
          echo "[Download config] Removed temporary directory"

      - name: Build release binary
        run: |
          echo "[Build] Rust version information:"
          rustc --version
          cargo --version
          echo "[Build] Starting cargo build --release"
          cargo build --release
          echo "[Build] Finished cargo build --release"

      - name: Run VCF pipeline
        run: |
          echo "[Run pipeline] Current directory: $(pwd)"
          echo "[Run pipeline] Available disk space:"
          df -h .
          echo "[Run pipeline] Listing ../vcfs contents:"
          ls -alh ../vcfs | head -n 50
          echo "[Run pipeline] Starting cargo run"
          cargo run --release --bin run_vcf -- \
            --vcf_folder ../vcfs \
            --config_file ../variants_freeze4inv_sv_inv_hg38_processed_arbigent_filtered_manualDotplot_filtered_PAVgenAdded_withInvCategs_syncWithWH.fixedPH.simpleINV.mod.tsv \
            --mask_file ../hardmask.hg38.v4_acroANDsdOnly.over99.bed \
            --reference ../hg38.no_alt.fa \
            --gtf ../gencode.v47.basic.annotation.gtf \
            --fst \
            --exclude "HG00514, HG00733, NA19240"
          echo "[Run pipeline] Finished cargo run"

      - name: Archive PHY files
        run: |
          set -euo pipefail
          echo "[Archive PHY] Searching for *.phy or *.phy.gz files in $(pwd)"
          shopt -s nullglob
          phy_files=( *.phy *.phy.gz )
          echo "[Archive PHY] Found ${#phy_files[@]} PHY files"
          if [ "${#phy_files[@]}" -gt 0 ]; then
            echo "[Archive PHY] Listing PHY files: ${phy_files[*]}"
            zip -r phy_outputs.zip "${phy_files[@]}"
            echo "[Archive PHY] Created phy_outputs.zip"
          else
            echo "No PHY files were generated. Skipping archiving."
          fi

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: run-vcf-output-csv
          path: output.csv
          if-no-files-found: error

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: run-vcf-logs
          path: ferromic_logs/**/*
          if-no-files-found: warn

      - name: Upload PHY artifact
        if: hashFiles('phy_outputs.zip') != ''
        uses: actions/upload-artifact@v4
        with:
          name: run-vcf-phy-outputs
          path: phy_outputs.zip
          if-no-files-found: error

      - name: Upload FALSTA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: run-vcf-falsta
          path: |
            per_site_diversity_output.falsta.gz
            per_site_fst_output.falsta.gz
          if-no-files-found: warn

      - name: Upload Hudson FST results
        if: hashFiles('hudson_fst_results.tsv.gz') != ''
        uses: actions/upload-artifact@v4
        with:
          name: run-vcf-hudson-fst
          path: hudson_fst_results.tsv.gz
          if-no-files-found: error

      - name: Upload Metadata Artifact
        if: hashFiles('phy_metadata.tsv') != ''
        uses: actions/upload-artifact@v4
        with:
          name: run-vcf-metadata
          path: phy_metadata.tsv
          if-no-files-found: error
