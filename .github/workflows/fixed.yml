name: Run Fixed Differences

on:
  workflow_dispatch:

permissions:
  actions: read
  contents: write

jobs:
  analyze-fixed-differences:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WRITE_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # fixed.py requires numpy and tqdm.
          pip install numpy tqdm

      - name: Download Sequence Data (Artifacts)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          echo "Locating latest successful run of manual_run_vcf.yml..."
          RUN_ID=$(gh run list --workflow manual_run_vcf.yml --status success --limit 1 --json databaseId -q '.[0].databaseId')
          
          if [[ -z "$RUN_ID" ]]; then
            echo "::error::No successful manual_run_vcf.yml run found. Cannot download sequence data."
            exit 1
          fi
          
          echo "Found Run ID: $RUN_ID"
          
          mkdir -p temp_downloads
          
          # Download the artifact containing the PHYLIP files
          echo "Downloading 'run-vcf-phy-outputs'..."
          gh run download "$RUN_ID" -n run-vcf-phy-outputs --dir temp_downloads
          
          # The artifact contains a zip file named phy_outputs.zip
          echo "Extracting phy_outputs.zip..."
          unzip -q temp_downloads/phy_outputs.zip -d .
          
          # Clean up zip
          rm -rf temp_downloads

      - name: Stage and Clean Data
        run: |
          set -euo pipefail
          
          # 1. Ensure inv_properties.tsv is in the Current Working Directory (CWD)
          if [[ -f "data/inv_properties.tsv" ]]; then
            cp data/inv_properties.tsv .
            echo "Copied inv_properties.tsv to root."
          else
            echo "::error::data/inv_properties.tsv not found in repo."
            exit 1
          fi
          
          # 2. Decompress PHYLIP files
          # fixed.py uses open(), not gzip.open()
          count_gz=$(find . -maxdepth 1 -name "*.phy.gz" | wc -l)
          if [[ "$count_gz" -gt 0 ]]; then
            echo "Decompressing $count_gz .phy.gz files..."
            gunzip *.phy.gz
          else
            echo "No .phy.gz files found (files might already be uncompressed)."
          fi
          
          # 3. MANUALLY RESOLVE CONFLICTS
          # The script fixed.py asserts only 1 alignment per gene/inversion.
          # We delete the specific files identified as duplicates/deprecated.
          
          echo "Resolving PINX1 conflict..."
          # Keep: ENSG00000258724 / ENST00000554914
          # Delete: ENSG00000254093 / ENST00000314787
          find . -name "*PINX1*ENSG00000254093*" -print -delete
          
          echo "Resolving ARHGAP11B conflict..."
          # Keep: ENSG00000285077 / ENST00000697964 (Canonical)
          # Delete: ENSG00000284906 / ENST00000685924 (Duplicate clone)
          find . -name "*ENSG00000284906*" -print -delete
          
          # 4. Verify presence of required files
          count_phy=$(find . -maxdepth 1 -name "*.phy" | wc -l)
          echo "Staging complete. Found $count_phy .phy files in root."

      - name: Run fixed.py
        run: |
          # The script expects inputs in CWD and writes outputs to CWD
          python stats/fixed.py

      - name: Move outputs into data directory
        run: |
          set -euo pipefail

          mkdir -p data
          mv -f gene_inversion_fixed_differences.tsv data/gene_inversion_fixed_differences.tsv
          mv -f fixed_diff_summary.tsv data/fixed_diff_summary.tsv

          ls -l data/gene_inversion_fixed_differences.tsv data/fixed_diff_summary.tsv

      - name: Commit and push fixed differences outputs
        env:
          PUSH_TOKEN: ${{ secrets.WRITE_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/gene_inversion_fixed_differences.tsv data/fixed_diff_summary.tsv

          if git diff --staged --quiet; then
            echo "No fixed differences outputs to commit"
          else
            git commit -m "Add fixed differences outputs"
            git pull https://${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git main --rebase --autostash --strategy=recursive -X ours
            git push https://${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:main
          fi

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: fixed-differences-report
          path: |
            data/gene_inversion_fixed_differences.tsv
            data/fixed_diff_summary.tsv
          if-no-files-found: warn
